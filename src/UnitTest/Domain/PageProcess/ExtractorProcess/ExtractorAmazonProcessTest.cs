using FluentAssertions;
using HtmlAgilityPack;
using Microsoft.Extensions.Options;
using WonderfullOffer.Api.Models.Settings.PageProcessSettings.Amazon;
using WonderfullOffers.Domain.Contracts.Domain.Processors.Amazon;
using WonderfullOffers.Domain.Models.Domain.Models.OfferWeb;
using WonderfullOffers.Tests.UnitTest.Hosting;

namespace WonderfullOffers.Tests.UnitTest.Domain.PageProcess.ExtractorProcess;

public class ExtractorAmazonProcessTest
{
    private readonly Host _host;
    private readonly IExtractorAmazonProcess _sut;
    private readonly AmazonSettings _amazonPageProcessSettings;

    public ExtractorAmazonProcessTest()
    {
        _host = new();
        _sut = _host.GetService<IExtractorAmazonProcess>();
        _amazonPageProcessSettings = _host.GetService<IOptions<AmazonSettings>>().Value;
    }

    [Theory]
    [InlineData("<div id=\"corePriceDisplay_desktop_feature_div\" class=\"celwidget\" data-feature-name=\"corePriceDisplay_desktop\" data-csa-c-type=\"widget\" data-csa-c-content-id=\"corePriceDisplay_desktop\" data-csa-c-slot-id=\"corePriceDisplay_desktop_feature_div\" data-csa-c-asin=\"B0BQ68H284\" data-csa-c-is-in-initial-active-row=\"false\" data-csa-c-id=\"8ei6px-pozq29-7q5ydp-riyxjt\" data-cel-widget=\"corePriceDisplay_desktop_feature_div\">\r\n                                           <style type=\"text/css\">\r\n    .savingPriceOverride {\r\n        color:#CC0C39!important;\r\n        font-weight: 300!important;\r\n    }\r\n</style>\r\n\r\n                              <div class=\"a-section a-spacing-none aok-align-center\">       <span aria-hidden=\"false\" class=\"a-size-large a-color-price savingPriceOverride aok-align-center reinventPriceSavingsPercentageMargin savingsPercentage\">-15&nbsp;%</span>         <span class=\"a-price aok-align-center reinventPricePriceToPayMargin priceToPay\" data-a-size=\"xl\" data-a-color=\"base\"><span class=\"a-offscreen\">169,15€</span><span aria-hidden=\"true\"><span class=\"a-price-whole\">169<span class=\"a-price-decimal\">,</span></span><span class=\"a-price-fraction\">15</span><span class=\"a-price-symbol\">€</span></span></span>              <span id=\"taxInclusiveMessage\" class=\"a-size-mini a-color-base aok-align-center aok-nowrap\">  </span>          </div>  <div class=\"a-section a-spacing-small aok-align-center\"> <span> <span class=\"aok-relative\"><span aria-hidden=\"false\" class=\"a-size-small a-color-secondary aok-align-center basisPrice\">Precio recomendado:          <span class=\"a-price a-text-price\" data-a-size=\"s\" data-a-strike=\"true\" data-a-color=\"secondary\"><span class=\"a-offscreen\">199,00€</span><span aria-hidden=\"true\">199,00€</span></span>      </span></span>  <span class=\"a-size-small aok-align-center basisPriceLegalMessage\">                        <span class=\"a-declarative\" data-action=\"a-popover\" data-csa-c-type=\"widget\" data-csa-c-func-deps=\"aui-da-a-popover\" data-a-popover=\"{&quot;closeButton&quot;:&quot;true&quot;,&quot;name&quot;:&quot;basisPriceLegalMessageDisplayPreload&quot;,&quot;position&quot;:&quot;triggerBottom&quot;}\" data-csa-c-id=\"3iiazb-gl4zaf-jybuvy-4t5vdz\">    <a href=\"javascript:void(0)\" role=\"button\" class=\"a-popover-trigger a-declarative reinventPriceLegalMessagePopover\">   <script>\r\n                                    P.when('A').execute(function(A){\r\n                                        A.on(\"a:popover:beforeShow:basisPriceLegalMessageDisplayPreload\", function(data) {\r\n                                            ue.trigger('OFFERSX_TOOLTIP_POSITION_UPDATE_561323', 'T1');\r\n                                        })\r\n                                    });\r\n                                </script>\r\n                                <svg aria-hidden=\"true\" class=\"reinventPrice_legalMessage_icon\" role=\"img\" xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 512 512\">\r\n                                    <path d=\"M256,9C119,9,8,120.08,8,257S119,505,256,505,504,394,504,257,393,9,256,9Zm0,76.31A47.69,47.69,0,1,1,208.31,133,47.69,47.69,0,0,1,256,85.31Zm38.15,332.38a12.18,12.18,0,0,1-12.21,12H229.67a11.85,11.85,0,0,1-11.82-12V249.92a11.86,11.86,0,0,1,11.82-12h52.27a12.18,12.18,0,0,1,12.21,12Z\"></path>\r\n                                </svg>\r\n                               <i class=\"a-icon a-icon-popover\"></i></a>   </span> <div class=\"a-popover-preload\" id=\"a-popover-basisPriceLegalMessageDisplayPreload\"> <div class=\"a-section a-spacing-none\"> <h3></h3> <span class=\"a-size-base\">El <b>PVPR</b> o <b>Precio recomendado</b> es el precio al  que el fabricante recomienda vender el producto y que ha sido proporcionado por el fabricante,  distribuidor u otro vendedor.<br><a class=\"a-link-normal\" href=\"https://www.amazon.es/gp/help/customer/display.html?language=es_ES&amp;nodeId=GQ6B6RH72AX8D2TD&amp;ref_=dp_hp\">Más información</a></span> </div> </div>    <style type=\"text/css\">\r\n    .reinventPrice_legalMessage_icon {\r\n        width: 12px;\r\n        fill: #969696;\r\n        vertical-align: middle;\r\n        padding-bottom: 2px;\r\n    }\r\n\r\n    .reinventPrice_legalMessage_icon:hover {\r\n        fill: #555555;\r\n    }\r\n</style>\r\n\r\n<script type=\"text/javascript\">\r\n    P.when('A', 'a-popover').execute('a-popover-count', function (A) {\r\n        A.declarative('a-popover', 'mouseenter', function() {\r\n            ue.count(\"tooltip.popover.opened\", 1);\r\n        });\r\n    });\r\n</script>  </span> </span> </div>                                        </div>",
        "//span[contains(text(), 'Precio recomendado: ')]",
        ".//span[contains(@class,'a-offscreen')]",
        199)]
    public async void Should_Extract_Price_Whitout_Offer(
        string inputHtml,
        string filterParent,
        string filter,
        decimal resultHtml) 
    {
        HtmlDocument htmlDocument = new();
        htmlDocument.LoadHtml(inputHtml);

        decimal? expected = await _sut.ExtractAmazonPriceWithoutDiscountAsync(
            htmlDocument.DocumentNode,
            filterParent,
            filter);


        resultHtml.Should().Be(expected);
    }

    [Theory]
    [InlineData("<div id=\"promoPriceBlockMessage_feature_div\" class=\"celwidget\" data-feature-name=\"promoPriceBlockMessage\" data-csa-c-type=\"widget\" data-csa-c-content-id=\"promoPriceBlockMessage\" data-csa-c-slot-id=\"promoPriceBlockMessage_feature_div\" data-csa-c-asin=\"B0B519H7QN\" data-csa-c-is-in-initial-active-row=\"false\" data-csa-c-id=\"5z76e-83c7xr-xygonl-itvflk\" data-cel-widget=\"promoPriceBlockMessage_feature_div\">\r\n                                         <div style=\"padding:0px 0px 0px 0px;\">\r\n                                                                                                                                                                                                                             <div class=\"offersConsistencyEnabled\">\r\n                                   <div id=\"reinvent_price_desktop_dealsAccordionRow\" style=\"\">\r\n                              <!--ocf0--> <span class=\"promoPriceBlockMessage\">\r\n             <!--cc-->           <div style=\"padding:5px 0px 5px 0px;\" data-csa-c-type=\"widget\" data-csa-c-slot-id=\"promo-cxcw-0-0\" data-csa-c-content-id=\"/promo/A1RXINBHQ4DDTU\" data-csa-c-coupon=\"true\" data-csa-c-savings=\"true\" data-csa-c-asin=\"B0B519H7QN\" data-csa-c-merchant=\"A384EIANXLAK7H\" data-csa-c-reftag=\"cxcw_clp\" data-csa-c-id=\"e5yfwi-td1ruq-vfmpig-ayixs2\">\r\n\r\n                                                        <i id=\"badgepctch015755150319586075\" class=\"a-icon a-icon-addon newCouponBadge\">Cupón:</i> &nbsp; <style> .newCouponBadge { color: black; font-weight: bold; background-color: #ff9900; white-space: nowrap; min-width: 54px; text-align: center; font-size: 14px; } .newCouponBadge:before { border-bottom: 10px solid #ff9900; } .newCouponBadge:after { border-top: 10px solid #ff9900; } </style> <div style=\"display:inline; margin-right: -6px\">      <span id=\"promoScriptpctch015755150319586075\"> <script type=\"text/javascript\">(function(f) {var _np=(window.P._namespace(\"promotionCCB\"));if(_np.guardFatal){_np.guardFatal(f)(_np);}else{f(_np);}}(function(P) { if (!window.scriptLoadedpctch015755150319586075) { window.scriptLoadedpctch015755150319586075 = true; P.when('A').execute(function(A){ A.declarative('pctch015755150319586075', 'change', function(event) { if('true' == \"true\") { window.location.href = '/promotion/signin/redeem' + '?' + '&asin=B0B519H7QN&promotionId=A1RXINBHQ4DDTU&encryptedPromotionId=A1RXINBHQ4DDTU&offerListingId=3tgiLsWXpT8s3zgFqiJUTMBkmkRfjpyQOnylKQFRaAoh2HdjWU6HxclS397v%2BZEd1kmaN8kn8Wr%2F53bfSLhBBG2FkFdBxr2fMB9TrkUfD4flF6x4BkKQpiW2jWU5L7O44OcbYeEu%2FIFzUX5PYCWFGSqGu4x3MfNXG4WEQnTmHSaThKjNoR%2FMG7hIGt1gEbfL&sku=AInanny-EU-EU&anti-csrftoken-a2z=g0NTW4xSoUnKBSJ80o1saLKggzrwWHlzbNooU%2B0kl4qFAAAAAQAAAABkx8YOcmF3AAAAAGfaM7%2Fie4v1Eo%2F7XVH8kQ%3D%3D&useRedirectOnSuccess=1'; } A.ajax('/promotion/signin/redeem', { method:'get', paramsFormat:'string', params:'&asin=B0B519H7QN&promotionId=A1RXINBHQ4DDTU&encryptedPromotionId=A1RXINBHQ4DDTU&offerListingId=3tgiLsWXpT8s3zgFqiJUTMBkmkRfjpyQOnylKQFRaAoh2HdjWU6HxclS397v%2BZEd1kmaN8kn8Wr%2F53bfSLhBBG2FkFdBxr2fMB9TrkUfD4flF6x4BkKQpiW2jWU5L7O44OcbYeEu%2FIFzUX5PYCWFGSqGu4x3MfNXG4WEQnTmHSaThKjNoR%2FMG7hIGt1gEbfL&sku=AInanny-EU-EU&anti-csrftoken-a2z=g0NTW4xSoUnKBSJ80o1saLKggzrwWHlzbNooU%2B0kl4qFAAAAAQAAAABkx8YOcmF3AAAAAGfaM7%2Fie4v1Eo%2F7XVH8kQ%3D%3D&useRedirectOnSuccess=1' + '&buyingOptionType=' + ''+ '&source=dp_' + 'cxcw' + '' + '' + '_6_' + 'T1' + '' + '' + '' + '' + '' + '' + '' + '' + '' + '', success: function(data) { if (data.includes('FAILURE') || data.includes('EXCEEDED')) { alert('Ha surgido un error desconocido. Vuelve a intentarlo en otro momento.'); return; } A.$('#cbpctch015755150319586075').addClass('aok-hidden'); A.$('#donepctch015755150319586075').removeClass('aok-hidden'); A.$('#cxWidgetBadgeParentpctch015755150319586075').addClass('aok-hidden'); A.$('#couponTextpctch015755150319586075').addClass('aok-hidden'); A.$('#cxWidgetBadgeParentpctch015755150319586075 + span').addClass('aok-hidden'); if(true) { A.$('#importantDetailspctch015755150319586075').removeClass('aok-hidden'); } }, error: function() { alert('Ha surgido un error desconocido. Vuelve a intentarlo en otro momento.'); } }); }); }); } }));</script> </span>  <img src=\"data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==\" alt=\"\" onload=\"window.requestAnimationFrame(function(){if (window.scriptLoadedpctch015755150319586075) {return;} var el=document.getElementById('promoScriptpctch015755150319586075'); if(el &amp;&amp; el.firstElementChild) {eval(el.firstElementChild.textContent)}})\"> <span class=\"a-declarative\" data-action=\"pctch015755150319586075\" data-csa-c-type=\"widget\" data-csa-c-func-deps=\"aui-da-pctch015755150319586075\" data-pctch015755150319586075=\"{}\" id=\"cbpctch015755150319586075\" data-csa-c-id=\"lrfykw-q7hwmm-t1wjri-qtqiss\"> <div class=\"a-checkbox a-checkbox-fancy aok-inline-block checkBoxCSS\"><label for=\"checkboxpctch015755150319586075\"><input id=\"checkboxpctch015755150319586075\" type=\"checkbox\" name=\"\" value=\"\"><i class=\"a-icon a-icon-checkbox\"></i><span class=\"a-label a-checkbox-label\"></span></label></div> </span> <span id=\"donepctch015755150319586075\" class=\"a-size-base a-color-success aok-hidden\">  <i class=\"a-icon a-icon-success a-icon-small\" role=\"presentation\"></i>         <span class=\"a-color-success\">&nbsp;Cupón de 20€ aplicado a un producto por pedido al tramitar el pedido  <a id=\"emphasisLink\" class=\"a-link-emphasis cxcwEmphasisLink\" href=\"/promotion/psp/A1RXINBHQ4DDTU?ref=clp_external&amp;redirectAsin=B0B519H7QN&amp;redirectMerchantId=A384EIANXLAK7H&amp;ref=cxcw_clp_A1RXINBHQ4DDTU\">Comprar artículos</a> <style>  .cxcwPopoverLink i { display: none; } .cxcwEmphasisLink { padding-left: 6px; padding-right: 6px; } </style> |  <span class=\"a-declarative\" data-action=\"a-modal\" data-csa-c-type=\"widget\" data-csa-c-func-deps=\"aui-da-a-modal\" data-a-modal=\"{&quot;backButtonText&quot;:&quot;Atrás&quot;,&quot;width&quot;:&quot;450&quot;,&quot;header&quot;:&quot;Condiciones&quot;,&quot;url&quot;:&quot;/promotion/details/popup/A1RXINBHQ4DDTU?ref=cxcw_bxgx_tc_A1RXINBHQ4DDTU&quot;,&quot;height&quot;:&quot;600&quot;}\" data-csa-c-id=\"k2sqrk-mjout1-uya61e-lufly\"> <a href=\"javascript:void(0)\" role=\"button\" class=\"a-popover-trigger a-declarative cxcwPopoverLink\">Condiciones<i class=\"a-icon a-icon-popover\"></i></a> </span> <style> .cxcwPopoverLink { padding-left: 6px; padding-right: 6px; } </style> &nbsp;</span> </span> <style> .checkBoxCSS:hover i { cursor: pointer; }  span#cbpctch015755150319586075 label { padding-left: 12px; text-indent: -12px; margin: 0; }  span#cbpctch015755150319586075 .a-control-row { padding-left: 1.8rem; } span#donepctch015755150319586075 i { margin-top: 4px; } </style>  </div>          <label for=\"checkboxpctch015755150319586075\" id=\"couponTextpctch015755150319586075\" style=\"display:inline; font-weight: normal; cursor: pointer;\"> Aplicar cupón de 20€  <a id=\"emphasisLink\" class=\"a-link-emphasis cxcwEmphasisLink\" href=\"/promotion/psp/A1RXINBHQ4DDTU?ref=clp_external&amp;redirectAsin=B0B519H7QN&amp;redirectMerchantId=A384EIANXLAK7H&amp;ref=cxcw_clp_A1RXINBHQ4DDTU\">Comprar artículos</a> <style>  .cxcwPopoverLink i { display: none; } .cxcwEmphasisLink { padding-left: 6px; padding-right: 6px; } </style> |  <span class=\"a-declarative\" data-action=\"a-modal\" data-csa-c-type=\"widget\" data-csa-c-func-deps=\"aui-da-a-modal\" data-a-modal=\"{&quot;backButtonText&quot;:&quot;Atrás&quot;,&quot;width&quot;:&quot;450&quot;,&quot;header&quot;:&quot;Condiciones&quot;,&quot;url&quot;:&quot;/promotion/details/popup/A1RXINBHQ4DDTU?ref=cxcw_bxgx_tc_A1RXINBHQ4DDTU&quot;,&quot;height&quot;:&quot;600&quot;}\" data-csa-c-id=\"fis4qh-adu3jp-tzcuma-a0oxcs\"> <a href=\"javascript:void(0)\" role=\"button\" class=\"a-popover-trigger a-declarative cxcwPopoverLink\">Condiciones<i class=\"a-icon a-icon-popover\"></i></a> </span> <style> .cxcwPopoverLink { padding-left: 6px; padding-right: 6px; } </style> </label> <style> label#couponTextpctch015755150319586075 span { padding-left: 6px; } </style>  <span id=\"importantDetailspctch015755150319586075\" class=\"a-color-secondary aok-hidden\">       Cupón válido hasta el martes 1 de agosto de 2023.  </span>       </div>\r\n         </span>\r\n     </div>\r\n                                                <div id=\"reinvent_price_desktop_newAccordionRow\" style=\"display:none;\">\r\n                              <!--ocf1--> <span class=\"promoPriceBlockMessage\">\r\n             <!--cc-->           <div style=\"padding:5px 0px 5px 0px;\" data-csa-c-type=\"widget\" data-csa-c-slot-id=\"promo-cxcw-1-0\" data-csa-c-content-id=\"/promo/A1RXINBHQ4DDTU\" data-csa-c-coupon=\"true\" data-csa-c-savings=\"true\" data-csa-c-asin=\"B0B519H7QN\" data-csa-c-merchant=\"A384EIANXLAK7H\" data-csa-c-reftag=\"cxcw_clp\" data-csa-c-id=\"hbmq6q-ncwnz8-m5ik6s-4qdhwq\">\r\n\r\n                                                        <i id=\"badgepctch39535496629165345\" class=\"a-icon a-icon-addon newCouponBadge\">Cupón:</i> &nbsp; <style> .newCouponBadge { color: black; font-weight: bold; background-color: #ff9900; white-space: nowrap; min-width: 54px; text-align: center; font-size: 14px; } .newCouponBadge:before { border-bottom: 10px solid #ff9900; } .newCouponBadge:after { border-top: 10px solid #ff9900; } </style> <div style=\"display:inline; margin-right: -6px\">      <span id=\"promoScriptpctch39535496629165345\"> <script type=\"text/javascript\">(function(f) {var _np=(window.P._namespace(\"promotionCCB\"));if(_np.guardFatal){_np.guardFatal(f)(_np);}else{f(_np);}}(function(P) { if (!window.scriptLoadedpctch39535496629165345) { window.scriptLoadedpctch39535496629165345 = true; P.when('A').execute(function(A){ A.declarative('pctch39535496629165345', 'change', function(event) { if('true' == \"true\") { window.location.href = '/promotion/signin/redeem' + '?' + '&asin=B0B519H7QN&promotionId=A1RXINBHQ4DDTU&encryptedPromotionId=A1RXINBHQ4DDTU&offerListingId=3tgiLsWXpT8s3zgFqiJUTMBkmkRfjpyQOnylKQFRaAoh2HdjWU6HxclS397v%2BZEd1kmaN8kn8Wr%2F53bfSLhBBG2FkFdBxr2fMB9TrkUfD4flF6x4BkKQpiW2jWU5L7O44OcbYeEu%2FIFzUX5PYCWFGSqGu4x3MfNXG4WEQnTmHSaThKjNoR%2FMG7hIGt1gEbfL&sku=AInanny-EU-EU&anti-csrftoken-a2z=g0NTW4xSoUnKBSJ80o1saLKggzrwWHlzbNooU%2B0kl4qFAAAAAQAAAABkx8YOcmF3AAAAAGfaM7%2Fie4v1Eo%2F7XVH8kQ%3D%3D&useRedirectOnSuccess=1'; } A.ajax('/promotion/signin/redeem', { method:'get', paramsFormat:'string', params:'&asin=B0B519H7QN&promotionId=A1RXINBHQ4DDTU&encryptedPromotionId=A1RXINBHQ4DDTU&offerListingId=3tgiLsWXpT8s3zgFqiJUTMBkmkRfjpyQOnylKQFRaAoh2HdjWU6HxclS397v%2BZEd1kmaN8kn8Wr%2F53bfSLhBBG2FkFdBxr2fMB9TrkUfD4flF6x4BkKQpiW2jWU5L7O44OcbYeEu%2FIFzUX5PYCWFGSqGu4x3MfNXG4WEQnTmHSaThKjNoR%2FMG7hIGt1gEbfL&sku=AInanny-EU-EU&anti-csrftoken-a2z=g0NTW4xSoUnKBSJ80o1saLKggzrwWHlzbNooU%2B0kl4qFAAAAAQAAAABkx8YOcmF3AAAAAGfaM7%2Fie4v1Eo%2F7XVH8kQ%3D%3D&useRedirectOnSuccess=1' + '&buyingOptionType=' + ''+ '&source=dp_' + 'cxcw' + '' + '' + '_6_' + 'T1' + '' + '' + '' + '' + '' + '' + '' + '' + '' + '', success: function(data) { if (data.includes('FAILURE') || data.includes('EXCEEDED')) { alert('Ha surgido un error desconocido. Vuelve a intentarlo en otro momento.'); return; } A.$('#cbpctch39535496629165345').addClass('aok-hidden'); A.$('#donepctch39535496629165345').removeClass('aok-hidden'); A.$('#cxWidgetBadgeParentpctch39535496629165345').addClass('aok-hidden'); A.$('#couponTextpctch39535496629165345').addClass('aok-hidden'); A.$('#cxWidgetBadgeParentpctch39535496629165345 + span').addClass('aok-hidden'); if(true) { A.$('#importantDetailspctch39535496629165345').removeClass('aok-hidden'); } }, error: function() { alert('Ha surgido un error desconocido. Vuelve a intentarlo en otro momento.'); } }); }); }); } }));</script> </span>  <img src=\"data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==\" alt=\"\" onload=\"window.requestAnimationFrame(function(){if (window.scriptLoadedpctch39535496629165345) {return;} var el=document.getElementById('promoScriptpctch39535496629165345'); if(el &amp;&amp; el.firstElementChild) {eval(el.firstElementChild.textContent)}})\"> <span class=\"a-declarative\" data-action=\"pctch39535496629165345\" data-csa-c-type=\"widget\" data-csa-c-func-deps=\"aui-da-pctch39535496629165345\" data-pctch39535496629165345=\"{}\" id=\"cbpctch39535496629165345\" data-csa-c-id=\"onpj4b-uk8lsf-36b7gd-vxv26q\"> <div class=\"a-checkbox a-checkbox-fancy aok-inline-block checkBoxCSS\"><label for=\"checkboxpctch39535496629165345\"><input id=\"checkboxpctch39535496629165345\" type=\"checkbox\" name=\"\" value=\"\"><i class=\"a-icon a-icon-checkbox\"></i><span class=\"a-label a-checkbox-label\"></span></label></div> </span> <span id=\"donepctch39535496629165345\" class=\"a-size-base a-color-success aok-hidden\">  <i class=\"a-icon a-icon-success a-icon-small\" role=\"presentation\"></i>         <span class=\"a-color-success\">&nbsp;Cupón de 20€ aplicado a un producto por pedido al tramitar el pedido  <a id=\"emphasisLink\" class=\"a-link-emphasis cxcwEmphasisLink\" href=\"/promotion/psp/A1RXINBHQ4DDTU?ref=clp_external&amp;redirectAsin=B0B519H7QN&amp;redirectMerchantId=A384EIANXLAK7H&amp;ref=cxcw_clp_A1RXINBHQ4DDTU\">Comprar artículos</a> <style>  .cxcwPopoverLink i { display: none; } .cxcwEmphasisLink { padding-left: 6px; padding-right: 6px; } </style> |  <span class=\"a-declarative\" data-action=\"a-modal\" data-csa-c-type=\"widget\" data-csa-c-func-deps=\"aui-da-a-modal\" data-a-modal=\"{&quot;backButtonText&quot;:&quot;Atrás&quot;,&quot;width&quot;:&quot;450&quot;,&quot;header&quot;:&quot;Condiciones&quot;,&quot;url&quot;:&quot;/promotion/details/popup/A1RXINBHQ4DDTU?ref=cxcw_bxgx_tc_A1RXINBHQ4DDTU&quot;,&quot;height&quot;:&quot;600&quot;}\" data-csa-c-id=\"r237bf-1ulwko-bm8lgd-9qxziy\"> <a href=\"javascript:void(0)\" role=\"button\" class=\"a-popover-trigger a-declarative cxcwPopoverLink\">Condiciones<i class=\"a-icon a-icon-popover\"></i></a> </span> <style> .cxcwPopoverLink { padding-left: 6px; padding-right: 6px; } </style> &nbsp;</span> </span> <style> .checkBoxCSS:hover i { cursor: pointer; }  span#cbpctch39535496629165345 label { padding-left: 12px; text-indent: -12px; margin: 0; }  span#cbpctch39535496629165345 .a-control-row { padding-left: 1.8rem; } span#donepctch39535496629165345 i { margin-top: 4px; } </style>  </div>          <label for=\"checkboxpctch39535496629165345\" id=\"couponTextpctch39535496629165345\" style=\"display:inline; font-weight: normal; cursor: pointer;\"> Aplicar cupón de 20€  <a id=\"emphasisLink\" class=\"a-link-emphasis cxcwEmphasisLink\" href=\"/promotion/psp/A1RXINBHQ4DDTU?ref=clp_external&amp;redirectAsin=B0B519H7QN&amp;redirectMerchantId=A384EIANXLAK7H&amp;ref=cxcw_clp_A1RXINBHQ4DDTU\">Comprar artículos</a> <style>  .cxcwPopoverLink i { display: none; } .cxcwEmphasisLink { padding-left: 6px; padding-right: 6px; } </style> |  <span class=\"a-declarative\" data-action=\"a-modal\" data-csa-c-type=\"widget\" data-csa-c-func-deps=\"aui-da-a-modal\" data-a-modal=\"{&quot;backButtonText&quot;:&quot;Atrás&quot;,&quot;width&quot;:&quot;450&quot;,&quot;header&quot;:&quot;Condiciones&quot;,&quot;url&quot;:&quot;/promotion/details/popup/A1RXINBHQ4DDTU?ref=cxcw_bxgx_tc_A1RXINBHQ4DDTU&quot;,&quot;height&quot;:&quot;600&quot;}\" data-csa-c-id=\"wtkgee-ix41jx-1rwgve-4o3pek\"> <a href=\"javascript:void(0)\" role=\"button\" class=\"a-popover-trigger a-declarative cxcwPopoverLink\">Condiciones<i class=\"a-icon a-icon-popover\"></i></a> </span> <style> .cxcwPopoverLink { padding-left: 6px; padding-right: 6px; } </style> </label> <style> label#couponTextpctch39535496629165345 span { padding-left: 6px; } </style>  <span id=\"importantDetailspctch39535496629165345\" class=\"a-color-secondary aok-hidden\">       Cupón válido hasta el martes 1 de agosto de 2023.  </span>       </div>\r\n         </span>\r\n     </div>\r\n                                                                                    </div>\r\n         </div>\r\n                               </div>",
        "//label[contains(text(), 'Aplicar cupón de')]",
        20)]
    public async void Should_Extract_Coupon(
        string inputHtml,
        string filter,
        int resultHtml)
    {
        HtmlDocument htmlDocument = new();
        htmlDocument.LoadHtml(inputHtml);

        int? expected = await _sut.ExtractAmazonCouponAsync(
            htmlDocument.DocumentNode,
            filter);


        resultHtml.Should().Be(expected);
    }

    [Theory]
    [InlineData("<div aria-label=\"Oferta: KERDOM Sillas Ergonomicas Oficina, Silla de Escritorio con Soporte Lumbar,Reposacabezas Ajustable, Reposabrazos, Silla 360° Giratoria para computadora,Blanco; \" class=\"DealCard-module__card_1u9yKYV4EIA-fL4ibeMVIU DealCard-module__cardWithoutActionButton_1K_FldevdoXxE8uy5pzBmr\" data-testid=\"deal-card\" data-deal-id=\"0a84b622\" data-csa-c-type=\"item\" data-csa-c-item-type=\"deal\" data-csa-c-item-id=\"amzn1.deal.0a84b622\" data-csa-c-painter=\"deals-grid\" data-csa-c-posx=\"3\" data-csa-c-owner=\"DealsX\" data-csa-c-id=\"qaswbw-xi2itp-tick89-plisf8\"><a class=\"a-link-normal DealCard-module__linkOutlineOffset_2fc037WfeGSjbFp1CAhOUn\" href=\"https://www.amazon.es/Ergonomicas-KERDOM-Reposacabezas-Reposabrazos-computadora/dp/B09TR8H39W?pf_rd_r=9NEZ0RG60JTGJS2GNBPM&amp;pf_rd_t=Events&amp;pf_rd_i=deals&amp;pf_rd_p=9406c473-d65f-4512-bc20-ca3dc2632f3d&amp;pf_rd_s=slot-14&amp;ref=dlx_deals_gd_dcl_img_2_0a84b622_dt_sl14_3d\"><div class=\"DealCard-module__cardImageVertical_1m9E6mjbE6UbrGJwvn6GKM DealCard-module__imageWithPadding_Qk9F2b8bUeXPk8FUBnSVG\"><div class=\"a-image-container a-dynamic-image-container aok-align-center-horizontally DealImage-module__image_1aM-S1pMSsajamWgCRXa6y DealImage-module__imageAspectRatioFix_DJdrM5BSpMhSiPB6czCA4\"><img alt=\"KERDOM Sillas Ergonomicas Oficina, Silla de Escritorio con Soporte Lumbar,Reposacabezas Ajustable, Reposabrazos, Silla 360...\" src=\"https://m.media-amazon.com/images/I/512+bdLgBrL._AC_UF226,226_FMjpg_.jpg\" class=\"DealImage-module__imageObjectFit_1G4pEkUEzo9WEnA3Wl0XFv\" data-a-hires=\"https://m.media-amazon.com/images/I/512+bdLgBrL._AC_UF452,452_FMjpg_.jpg\"></div></div></a><div class=\"DealCard-module__contentWithPadding_1mEcEYf1DvbvZJ9zcQCxtw\"><span aria-live=\"off\" class=\"a-size-mini a-color-base\"><div class=\"BadgeAutomated-module__badgeOneLineContainer_yYupgq1lKxb5h3bfDqA-B\"><div class=\"BadgeAutomatedLabel-module__badgeAutomatedLabel_2Teem9LTaUlj6gBh5R45wd\" style=\"color: rgb(255, 255, 255); background: rgb(204, 12, 57);\">Hasta un -24%</div><time class=\"DealMessaging-module__dealMessaging_1EIwT6BUaB6vCKvPVEbAEV\" role=\"timer\" style=\"color: rgb(204, 12, 57); background: rgb(255, 255, 255);\">Oferta</time></div><div class=\"BadgeAutomated-module__badgeLayoutCheck_1J0nKx-ocgm90oYWcNYv5F BadgeAutomated-module__badgeOneLineContainer_yYupgq1lKxb5h3bfDqA-B\" aria-hidden=\"true\"><div class=\"BadgeAutomatedLabel-module__badgeAutomatedLabel_2Teem9LTaUlj6gBh5R45wd\" style=\"color: rgb(255, 255, 255); background: rgb(204, 12, 57);\">Hasta un -24%</div><time class=\"DealMessaging-module__dealMessaging_1EIwT6BUaB6vCKvPVEbAEV\" role=\"timer\" style=\"color: rgb(204, 12, 57); background: rgb(255, 255, 255);\">Oferta</time></div></span><a class=\"a-link-normal DealLink-module__dealLink_3v4tPYOP4qJj9bdiy0xAT a-color-base a-text-normal\" href=\"https://www.amazon.es/Ergonomicas-KERDOM-Reposacabezas-Reposabrazos-computadora/dp/B09TR8H39W?pf_rd_r=9NEZ0RG60JTGJS2GNBPM&amp;pf_rd_t=Events&amp;pf_rd_i=deals&amp;pf_rd_p=9406c473-d65f-4512-bc20-ca3dc2632f3d&amp;pf_rd_s=slot-14&amp;ref=dlx_deals_gd_dcl_tlt_2_0a84b622_dt_sl14_3d\"><div class=\"DealContent-module__truncate_sWbxETx42ZPStTc9jwySW\">KERDOM Sillas Ergonomicas Oficina, Silla de Escritorio con Soporte Lumbar,Reposacabezas Ajustable, Reposabrazos, Silla 360° Giratoria para computadora,Blanco</div></a></div></div>",
        "//div[starts-with(@class, 'DealContent-module__truncate')]",
        "//div[starts-with(@class, 'BadgeAutomatedLabel-module__badgeAutomatedLabel')]"
        )]
    public async void Should_Extract_Offer(
        string inputHtml,
        string filterTitle,
        string filterDiscount)
    {
        HtmlDocument htmlDocument = new();
        htmlDocument.LoadHtml(inputHtml);

        AmazonOffer expected = await _sut.ExtractAmazonOfferAsync(
            htmlDocument.DocumentNode,
            filterTitle,
            filterDiscount);

        AmazonOffer result = new()
        {
            Uri = new Uri("https://www.amazon.es/Ergonomicas-KERDOM-Reposacabezas-Reposabrazos-computadora/dp/B09TR8H39W?pf_rd_r=9NEZ0RG60JTGJS2GNBPM&amp;pf_rd_t=Events&amp;pf_rd_i=deals&amp;pf_rd_p=9406c473-d65f-4512-bc20-ca3dc2632f3d&amp;pf_rd_s=slot-14&amp;ref=dlx_deals_gd_dcl_img_2_0a84b622_dt_sl14_3d"),
            Title = "KERDOM Sillas Ergonomicas Oficina, Silla de Escritorio con Soporte Lumbar,Reposacabezas Ajustable, Reposabrazos, Silla 360° Giratoria para computadora,Blanco",
            Img = new Uri("https://m.media-amazon.com/images/I/512+bdLgBrL._AC_UF226,226_FMjpg_.jpg"),
            Disccount = 24
        };

        expected.Should().BeEquivalentTo(result);
    }
}
